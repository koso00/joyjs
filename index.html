<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
<body>
  <p id = "log"></p>
</body>
<script>
mouse = {
  left : 0,top : 0
}

joystick = {
  down : false,
  up : false,
  left: false,
  right: false
}
bodyset = false;
stickhandler = false;

$('body').on("mousemove",function(e) {
  mouse.left = e.pageX - $(document).scrollLeft() - $('body').offset().left
  mouse.top = e.pageY - $(document).scrollTop() - $('body').offset().top
  if (stickhandler) {definestick(mouse.left,mouse.top);}
});

document.addEventListener('touchmove', function(e) {
    var touch = e.touches[0];
    mouse.left = touch.pageX - $(document).scrollLeft() - $('body').offset().left
    mouse.top = touch.pageY - $(document).scrollTop() - $('body').offset().top
      if (stickhandler) {definestick(mouse.left,mouse.top);}
}, false);


function joystick_start()
{
$("body").on("touchstart",function(e){
    var touch = e.touches[0];
    mouse.left = touch.pageX - $(document).scrollLeft() - $('body').offset().left
    mouse.top = touch.pageY - $(document).scrollTop() - $('body').offset().top
    console.log(mouse.left +  " " + mouse.top)
  })
 $("body").on("touchstart mousedown",mousedownhandler)
 $("body").on("touchend mouseup",mouseuphandler)
}

function joystick_pause()
{
$("body").off("mousedown",mousedownhandler);
$("body").off("mouseup",mouseuphandler);

$("body").off("touchstart",mousedownhandler)
$("body").off("touchend",mouseuphandler)
}

function mousedownhandler(){
  definestick(mouse.left,mouse.top);
  stickhandler = true;
}

function mouseuphandler(){
  bodyset = false;
  stickhandler = false;
  $(".stick").fadeOut(200)
  $(".joy").fadeOut(200)
  setTimeout(function(){
    $(".stick").remove()
    $(".joy").remove()
  },200)
}

joystick_start();




function definestick(left,top)
{
  if (bodyset == false){
    abs = {
      x : left,
      y: top
    }
    stick = $("<div></div>");
    stick.css({
      position : "absolute" ,
    "background-color":"black",
    "border-radius" : "50%",
       height:100,
       width:100,
       "left":left - 50,
       "top":top -50
    });
    stick.addClass( "stick")
    stick.appendTo("body").hide().fadeIn(200);
    s =  $("<div></div>");
    s.css({
      position : "absolute" ,
    "background-color":"red",
    "border-radius" : "50%",
       height:50,
       width:50,
       "left":left - 25,
       "top":top -25
    })
    s.addClass( "joy")
    s.appendTo("body").hide().fadeIn(200);
    bodyset = true;
  }else{
    p1 = {
      x : 0,
      y : 0
    }
    p2 = {
      x : mouse.left -  parseInt($(".stick").css("left"))-50,
      y : mouse.top  -  parseInt($(".stick").css("top"))-50
    }
    abs = {
      x : parseInt($(".stick").css("left"))-50,
      y: parseInt($(".stick").css("top"))-50
    }
    Vx = p2.x - p1.x;
    Vy = p1.y - p2.y;
    distance = Math.sqrt( Vy*Vy + Vx*Vx )
    var radians = Math.atan2(Vy, Vx);
    if (radians < 0) radians += 2*Math.PI;

    $("#log").text(abs.x + "   " +abs.y + " " + $(".joy").css("left") + " " + $(".joy").css("top"))

    if (Math.abs(left -  parseInt($(".stick").css("left"))-50) < Math.abs(Math.cos(radians)*50)){
    $(".joy").css("left",left - 25);}else{
    $(".joy").css("left",abs.x + 74 + Math.cos(radians)*50)
    }


    if (Math.abs(top -  parseInt($(".stick").css("top"))-50) <  Math.abs(Math.sin(radians)*50)){
    $(".joy").css("top",top - 25);}else{
      $(".joy").css("top",abs.y + 74 + Math.sin(radians)*-50)
    }

  }





	//console.log( Math.round(radians*180/Math.PI));
  //console.log( p1.x  + "  " + p1.y  + "       " +p2.x  + "  " + p2.y)
}


</script>
